---
title: "Functionalizing Rasters from NEON"
author: "Naupaka Zimmerman"
date: "June 21, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Objectives

Start by putting up objectives/tasks that students will be working though:

1. Import a raster — A lidar canopy height model (lidar/Teak_lidarCHM.tif)
1. For the CHM, set values == 0 to NA (not trees)
1. Visualize density and plot vertical cutoff lines.
1. Classify the raster according to some distribution – low medium and tall trees. This could be done using a histogram potentially or we could just decide that 6m is generally understory, 10m small trees,and the rest are tall trees. A function could import the desired thresholds. 
1. Plot the classified raster, add a legend for each “class” - legends are super tricky to simplifying this process with a function would be good.  see: http://neon-workwithdata.github.io/neon-data-institute-2016/R/classify-by-threshold-R/ for my take on forcing a legend outside of the plot area using par settings. You may have other better forms of magic to make this work well. :)
1. Export the plot figure to a pdf – publishable
1. Export the classified raster as a geotiff with NaFlagg = -9999 to an outputs folder.

```{r}
# load library
library("raster")

# Setting some parameters
chm_file <- "../NEONdata/D17-California/TEAK/2013/lidar/TEAK_lidarCHM.tif"
chosen.breaks <- c(6, 30, 50, 100)

chm <- raster(chm_file)

# quick sanity check
plot(chm)

# set 0 values
chm[chm == 0] <- NA
plot(chm)

# check dinsity plot
density(chm)



#############
#############
# function to create a reclassify matrix from a set of breaks
create_height_class_matrix <- function(breaks) {
	# Get the length of the breaks vector to 
	# figure how many classes we will have
	br.len <- length(breaks)
	
	# initialize height class vector with 0
	height.class.m <- c(0)
	
	# for input of breaks = c(6, 30, 50, 100)
	# we would like to make something like this:
	
	# c(0, 6, 1,
	#	6, 30, 2,
	#	30, 50, 3,
	#	50, 100, 4)
	
	for (i in 1:br.len) {
		height.class.m <- c(height.class.m, breaks[i - 1], breaks[i], i)
	}
	
	reclass.height.mat <- matrix(height.class.m,
								 ncol = 3,
								 byrow = TRUE)	

	reclass.height.mat
}

create_height_class_matrix(chosen.breaks)

## a function to plot density of heights with chosen breaks
# expects a chm raster, a title, and vector of breaks
plot_chm_density <- function(rast.in, title, bins) {
	density(rast.in, main = title, xlab = "Height (m)")
	abline(v = bins, col = "red")
}

plot_chm_density(rast.in = chm, 
				 title = "Canopy heights at Teakettle", 
				 bins = chosen.breaks)

# reclassify our raster
reclassified.chm <- reclassify(chm,
							   reclass.height.mat)


# Function to save a pdf from a function that produces a figure
make_pdf <- function(expr, filename, ..., verbose = TRUE) {
    if (verbose) {
        message("Creating: ", filename)
    }
    pdf(file = filename, ...)
    on.exit(dev.off())
    eval.parent(substitute(expr))
}

# plot density figure with breaks to pdf file
make_pdf(plot_chm_density(rast.in = chm, 
				 title = "Canopy heights at Teakettle", 
				 bins = chosen.breaks), 
		 filename = "TEAK_CHM_density_with_breaks.pdf", 
		 width = 6, height = 7)




##########################################
##########################################
# function to plot the reclassified raster

plot_reclassified_raster <- function(rast.in, site.name, breaks){
	# this is a tricky bit because we need to out the legend
	# outside of the plot region
	
	# Get colors for plotting
	bin.colors <- rev(terrain.colors(length(breaks)))
	
	# make room for a legend
	
	par(xpd = FALSE, mar = c(5.1, 4.1, 4.1, 4.5))
	
	# plot
	plot(rast.in,
		 col = bin.colors,
		 main = paste("Canopy height classes \n", site.name),
		 legend = FALSE)
	
	# allow legend to plot outside of bounds
	par(xpd = TRUE)
	
	# legend x
	leg.x <- par()$usr[2] + 20
	
	# legend y
	leg.y <- par()$usr[4] + 50 - (abs(par()$usr[3] - par()$usr[4]) / 2) 
	
	# create legend text
	height.mat <- create_height_class_matrix(breaks)
	
	# initialize legend text
	legend.text <- c()
	
	for (i in 1:length(breaks)) {
		
		legend.text <- c(legend.text, 
						 paste0(height.mat[i, 1], "-", 
						 	   height.mat[i, 2], " m"))
	}
	
	# create the legend
	legend(leg.x, leg.y,  # set x,y legend location
		   legend = legend.text,  # make sure the order matches colors
		   fill = bin.colors,
		   bty = "n") # turn off border
	
	# turn off plotting outside of bounds
	par(xpd = FALSE)
}


make_pdf(plot_reclassified_raster(reclassified.chm, 
								  site.name = "Teakettle",
								  breaks = chosen.breaks), 
		 filename = "canopy_height_map_reclassified_TEAK.pdf",
		 width = 6, height = 6)

# Save the reclassified raster to a GeoTIFF
writeRaster(reclassified.chm,
			filename = "reclassified_CHM_TEAK_GeoTIFF.tif",
			format = "GTiff",
			options = "COMPRESS=LZW",
			overwrite = TRUE,
			NAflag = -9999)

sink(paste0(format(Sys.time(), "%Y-%m-%d_%H%M%S"),
			"_sessionInfo.txt"))
sessionInfo()
sink()

```
